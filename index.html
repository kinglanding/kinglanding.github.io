<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>曾经渐行远，未免心戚戚</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="曾经渐行远，未免心戚戚">
<meta property="og:url" content="http://aluenkinglee.com/index.html">
<meta property="og:site_name" content="曾经渐行远，未免心戚戚">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="曾经渐行远，未免心戚戚">
<meta name="twitter:description">
  
    <link rel="alternative" href="/atom.xml" title="曾经渐行远，未免心戚戚" type="application/atom+xml">
  
  
    <link href="/favicon.ico" rel="icon" type="image/x-ico">
  
  <link rel="stylesheet" href="/css/style.css"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="null" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Aluen King Lee</a></h1>
		</hgroup>

		
		<p class="header-subtitle">A blogging framework for hackers.</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
						
						
						<li>Über</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
							<li><a href="/tags/随笔">随笔</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="#" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
					        
								<a class="rss" target="_blank" href="#" title="rss">rss</a>
					        
								<a class="zhihu" target="_blank" href="#" title="zhihu">zhihu</a>
					        
								<a class="douban" target="_blank" href="#" title="douban">douban</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/ThreadPool/" style="font-size: 10px;">ThreadPool</a> <a href="/tags/java线程池/" style="font-size: 10px;">java线程池</a> <a href="/tags/线程/" style="font-size: 10px;">线程</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">我是谁，我从哪里来，我到哪里去？我就是我，是颜色不一样的吃货…</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">Aluen King Lee</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="null" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">Aluen King Lee</h1>
			</hgroup>
			
			<p class="header-subtitle">A blogging framework for hackers.</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/tags/随笔">随笔</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="#" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="#" title="rss">rss</a>
			        
						<a class="zhihu" target="_blank" href="#" title="zhihu">zhihu</a>
			        
						<a class="douban" target="_blank" href="#" title="douban">douban</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
  
    <article id="post-2016-04-27-think-about-difference-of-exception-between-thread-and-pool" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/04/27/2016-04-27-think-about-difference-of-exception-between-thread-and-pool/" class="article-date">
  	<time datetime="2016-04-27T05:09:21.000Z" itemprop="datePublished">2016-04-27</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/27/2016-04-27-think-about-difference-of-exception-between-thread-and-pool/">关于异常在线程与线程池不同表现的一个思考</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>如果一个线程在执行的过程中，遇到了某种异常，中断异常啊、空指针异常啊、算数异常，并且程序本身没有捕获异常，会发送什么？你可能会说，程序直接挂掉呗~然后日志里有异常日志。</p>
<p>但实际上，要看这个线程是在什么地方。如果是在线程池外面，这个程序确实就直接挂掉了；</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    testThreadFeatures();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testThreadFeatures</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Thread thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">char</span>[] ast = <span class="keyword">null</span>;</span><br><span class="line">            String str = <span class="keyword">new</span> String(ast);</span><br><span class="line"></span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" ： can you see me :&gt;...."</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">"thread1"</span>);</span><br><span class="line"></span><br><span class="line">    thread.run();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>结果，毫无意外的显示为：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; java.lang.NullPointerException</span><br><span class="line"> 	at java.lang.String.&lt;init&gt;(String.java:168)</span><br><span class="line"> 	at thread.ThreadRunAndHang$1.run(ThreadRunAndHang.java:51)</span><br><span class="line"> 	at java.lang.Thread.run(Thread.java:744)</span><br><span class="line"> 	at thread.ThreadRunAndHang.testThreadFeatures(ThreadRunAndHang.java:58)</span><br><span class="line"> 	at thread.ThreadRunAndHang.main(ThreadRunAndHang.java:42)</span><br><span class="line"> 	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line"> 	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)</span><br><span class="line"> 	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line"> 	at java.lang.reflect.Method.invoke(Method.java:606)</span><br><span class="line"> 	at com.intellij.rt.execution.application.AppMain.main(AppMain.java:140)</span><br></pre></td></tr></table></figure></p>
<p>如果是在线程池中呢？线程池怎么捕捉线程出现的异常？例如 一个线程因为某个RuntimeException导致线程挂了。如何处理呢？</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testThreadPoolFeatures</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       ExecutorService service = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">10</span>, <span class="number">10</span>, <span class="number">100</span>, TimeUnit.MILLISECONDS, </span><br><span class="line">       <span class="keyword">new</span> LinkedBlockingDeque&lt;Runnable&gt;(), </span><br><span class="line">       <span class="keyword">new</span> DefaultThreadFactory());</span><br><span class="line"></span><br><span class="line">       Thread thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               System.out.println(Thread.currentThread().getName() + </span><br><span class="line">                   <span class="string">" ： hello i am running...."</span>);</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   TimeUnit.SECONDS.sleep(<span class="number">30</span>);</span><br><span class="line">               &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                   e.printStackTrace();</span><br><span class="line">               &#125;</span><br><span class="line">               System.out.println(Thread.currentThread().getName() + </span><br><span class="line">                   <span class="string">" : now i begin to make something different...."</span>);</span><br><span class="line"></span><br><span class="line">               <span class="keyword">char</span>[] ast = <span class="keyword">null</span>;</span><br><span class="line">               String str = <span class="keyword">new</span> String(ast);</span><br><span class="line"></span><br><span class="line">               System.out.println(Thread.currentThread().getName() + </span><br><span class="line">                   <span class="string">" ： can you see me :&gt;...."</span>);</span><br><span class="line"></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;, <span class="string">"thread1"</span>); <span class="comment">// 这里给线程命名其实是不管用的哈！因为有ThreadFactory，那里面对线程重新命名了=。=</span></span><br><span class="line">       </span><br><span class="line">       Thread thread2 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               System.out.println(Thread.currentThread().getName() + </span><br><span class="line">                   <span class="string">" ： hello i am running...."</span>);</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">               &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                   e.printStackTrace();</span><br><span class="line">               &#125;</span><br><span class="line">               System.out.println(Thread.currentThread().getName() + </span><br><span class="line">                   <span class="string">" ： now i begin to make something different...."</span>);</span><br><span class="line"></span><br><span class="line">               System.out.println(Thread.currentThread().getName() + </span><br><span class="line">                   <span class="string">" ： can you see me :&gt;...."</span>);</span><br><span class="line">               <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                   ;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;, <span class="string">"thread2"</span>);</span><br><span class="line">       service.submit(thread);</span><br><span class="line">       service.submit(thread2);</span><br><span class="line">       System.out.println(<span class="string">"running...."</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>结果显示,但是程序本身并没有终止运行。
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> running....</span><br><span class="line"><span class="built_in">test</span>-1-thread-2 ： hello i am running....</span><br><span class="line"><span class="built_in">test</span>-1-thread-1 ： hello i am running....</span><br><span class="line"><span class="built_in">test</span>-1-thread-2 ： now i begin to make something different....</span><br><span class="line"><span class="built_in">test</span>-1-thread-2 ： can you see me :&gt;....</span><br><span class="line"><span class="built_in">test</span>-1-thread-1 : now i begin to make something different....</span><br></pre></td></tr></table></figure></p>
<p>感兴趣的话可以查看下程序栈，会发现线程test-1-thread-1是处于WAITING状态的！尝试从queue队列中取新的任务。所以是WAITING状态</p>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"test-1-thread-2"</span> prio=6 tid=0x000000000c42b800 nid=0x2e9c waiting on condition [0x000000000d10f000]</span><br><span class="line">   java.lang.Thread.State: WAITING (parking)</span><br><span class="line">	at sun.misc.Unsafe.park(Native Method)</span><br><span class="line">	- parking to <span class="built_in">wait</span> <span class="keyword">for</span>  &lt;0x00000007d6088290&gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer<span class="variable">$ConditionObject</span>)</span><br><span class="line">	at java.util.concurrent.locks.LockSupport.park(LockSupport.java:186)</span><br><span class="line">	at java.util.concurrent.locks.AbstractQueuedSynchronizer<span class="variable">$ConditionObject</span>.await(AbstractQueuedSynchronizer.java:2043)</span><br><span class="line">	at java.util.concurrent.LinkedBlockingDeque.takeFirst(LinkedBlockingDeque.java:489)</span><br><span class="line">	at java.util.concurrent.LinkedBlockingDeque.take(LinkedBlockingDeque.java:678)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1068)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1130)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor<span class="variable">$Worker</span>.run(ThreadPoolExecutor.java:615)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:744)</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">	- None</span><br><span class="line"></span><br><span class="line"><span class="string">"test-1-thread-1"</span> prio=6 tid=0x000000000c42b000 nid=0x3a0 waiting on condition [0x000000000cf2f000]</span><br><span class="line">   java.lang.Thread.State: WAITING (parking)</span><br><span class="line">	at sun.misc.Unsafe.park(Native Method)</span><br><span class="line">	- parking to <span class="built_in">wait</span> <span class="keyword">for</span>  &lt;0x00000007d6088290&gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer<span class="variable">$ConditionObject</span>)</span><br><span class="line">	at java.util.concurrent.locks.LockSupport.park(LockSupport.java:186)</span><br><span class="line">	at java.util.concurrent.locks.AbstractQueuedSynchronizer<span class="variable">$ConditionObject</span>.await(AbstractQueuedSynchronizer.java:2043)</span><br><span class="line">	at java.util.concurrent.LinkedBlockingDeque.takeFirst(LinkedBlockingDeque.java:489)</span><br><span class="line">	at java.util.concurrent.LinkedBlockingDeque.take(LinkedBlockingDeque.java:678)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1068)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1130)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor<span class="variable">$Worker</span>.run(ThreadPoolExecutor.java:615)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:744)</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">	- None</span><br></pre></td></tr></table></figure></p>
<p>看接口Runnable的定义，及其简洁
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * When an object implementing interface &lt;code&gt;Runnable&lt;/code&gt; is used</span><br><span class="line">     * to create a thread, starting the thread causes the object's</span><br><span class="line">     * &lt;code&gt;run&lt;/code&gt; method to be called in that separately executing</span><br><span class="line">     * thread.</span><br><span class="line">     * &lt;p&gt;</span><br><span class="line">     * The general contract of the method &lt;code&gt;run&lt;/code&gt; is that it may</span><br><span class="line">     * take any action whatsoever.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@see</span>     java.lang.Thread#run()</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>但是定义成这样，就意味着我们没有办法在run()方法的实现中抛出异常，啊哈哈，没有办法抛出Checked异常啦。要处理checked exception，简单的一个try/catch块就可以了。但是万一程序里不小心抛出一个RuntimeException，又该咋办捏？</p>
<p>还是看Thread源码，已经规定了这么一个玩意儿，<code>UncaughtExceptionHandler</code>这个接口的实现可以用来处理那些线程未捕获的异常。</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UncaughtExceptionHandler</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span><br><span class="line">         * Method invoked when the given thread terminates due to the</span><br><span class="line">         * given uncaught exception.</span><br><span class="line">         * &lt;p&gt;Any exception thrown by this method will be ignored by the</span><br><span class="line">         * Java Virtual Machine.</span><br><span class="line">         * <span class="doctag">@param</span> t the thread</span><br><span class="line">         * <span class="doctag">@param</span> e the exception</span><br><span class="line">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">uncaughtException</span><span class="params">(Thread t, Throwable e)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// null unless explicitly set</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> UncaughtExceptionHandler uncaughtExceptionHandler;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// null unless explicitly set</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> UncaughtExceptionHandler defaultUncaughtExceptionHandler;</span><br></pre></td></tr></table></figure></p>
<p>但是默认这类handler是没有设置的（<code>null unless explicitly set</code>）！这好办！自个儿写个UncaughtExceptionHandler接口的实现。</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> Thread.UncaughtExceptionHandler exceptionHandler = <span class="keyword">new</span> Thread.UncaughtExceptionHandler() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">uncaughtException</span><span class="params">(Thread t, Throwable e)</span> </span>&#123;</span><br><span class="line">        System.out.println(t.getName() + <span class="string">"有麻烦了，详情是："</span> + e.toString());</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        System.out.println(<span class="string">"线程的状态是："</span> + t.getState());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">thread.setDefaultUncaughtExceptionHandler(exceptionHandler);</span><br></pre></td></tr></table></figure></p>
<p>这么一来，运行结果就是这样啦。</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">main有麻烦了，详情是：java.lang.NullPointerException</span><br><span class="line">[Ljava.lang.StackTraceElement;@<span class="number">14</span>c4b664</span><br><span class="line">java.lang.NullPointerException</span><br><span class="line">	at java.lang.String.&lt;init&gt;(String.java:<span class="number">168</span>)</span><br><span class="line">	at thread.ThreadRunAndHang$<span class="number">1</span>.run(ThreadRunAndHang.java:<span class="number">51</span>)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:<span class="number">744</span>)</span><br><span class="line">	at thread.ThreadRunAndHang.testThreadFeatures(ThreadRunAndHang.java:<span class="number">66</span>)</span><br><span class="line">	at thread.ThreadRunAndHang.main(ThreadRunAndHang.java:<span class="number">42</span>)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:<span class="number">57</span>)</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="number">43</span>)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:<span class="number">606</span>)</span><br><span class="line">	at com.intellij.rt.execution.application.AppMain.main(AppMain.java:<span class="number">140</span>)</span><br></pre></td></tr></table></figure></p>
<p>这部分的输出正好就是UncaughtExceptionHandler接口的实现。对于unchecked exception，可以采用类似事件注册的机制做一定程度的处理。程序也不会崩溃啦~~</p>
<h4>阶段性总结</h4>
<p>Java thread里面关于异常的部分比较奇特。接口的定义意味着不能直接在一个线程中抛出异常。一般在线程里碰到checked exception，标准的做法是采用try/catch块来处理。而对于unchecked exception，比较合理的方式是注册一个实现 UncaughtExceptionHandler 接口的对象实例来处理。</p>
<p>在回到线程池的问题中...</p>
<p>为啥线程池没有打印处理这些UncaughtException呢？(低声:因为你没有set线程池中线程的 UncaughtExceptionHandler 啊...)=。=好吧！在DefaultThreadFactory的newThread方法中加上线程的UncaughtExceptionHandler嘛~。运行，一脸黑线，TMD的什么鬼，还是木有！！！</p>
<p>翻看了下 ThreadPoolExecutor 的代码，找到了这个关键点！！！看 runWorker 这个方法的注释哈！原文描述的第4点和第5点很重要~ 不贴代码了，可以看下<code>jdk1.7.0_51#ThreadPoolExecutor#runWorker#1081~1165</code></p>
<blockquote>
<p>假设 <code>beforeExecute</code> 运行没问题， 就开始执行<code>task</code>了，注意是调用 <code>task.ran</code> 当做普通方法调用的！！然后收集任何抛出的异常，扔给 <code>afterExecute （默认是空实现哈，所以异常没有被处理）</code>因为 <code>Runnable.run</code> 方法不能抛出 Throwables ，所以就打包扔了出去，其实是扔给线程的 UncaughtExceptionHandler 了。保险起见，任何抛出的异常都会导致线程挂掉。执行完 task.run 方法之后，就开始调用 <code>afterExecute</code> 了。 这个方法也可能会抛出异常，此时同样会导致线程挂掉。</p>
</blockquote>
<p>这个时候又看了下 <code>afterExecute</code> 的注释，重载或者重写该方法就好了，咱们直接这么用就好啦~ ExecutorService 对象的创建方法变一变，覆盖原来的方法.接下来就是见证奇迹的时刻~~</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ExecutorService service = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">10</span>, <span class="number">10</span>, <span class="number">100</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">        <span class="keyword">new</span> LinkedBlockingDeque&lt;Runnable&gt;(),</span><br><span class="line">        <span class="keyword">new</span> DefaultThreadFactory())</span><br><span class="line">        <span class="comment">// 覆盖ThreadPoolExecutor中的afterExecute方法！</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterExecute</span><span class="params">(Runnable r, Throwable t)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.afterExecute(r, t);</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">"有麻烦了，详情是："</span> + t.toString());</span><br><span class="line">        t.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>运行一下,见证下奇迹,你妹的,千呼万唤始出来啊</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">test-1-thread-2 ： hello i am running....</span><br><span class="line">test-1-thread-1 ： hello i am running....</span><br><span class="line">test-1-thread-2 ： now i begin to make something different....</span><br><span class="line">test-1-thread-2 ： can you see me :&gt;....</span><br><span class="line">java.lang.NullPointerException</span><br><span class="line">	at thread.ThreadRunAndHang$3.afterExecute(ThreadRunAndHang.java:82)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1153)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:744)</span><br><span class="line">test-1-thread-1 : now i begin to make something different....</span><br><span class="line">Thread-2</span><br><span class="line">test-1-thread-1有麻烦了，详情是：java.lang.NullPointerException</span><br><span class="line">线程的状态是：RUNNABLE</span><br></pre></td></tr></table></figure></p>
<h4>阶段性总结</h4>
<p>线程池如果想要处理unchecked exception :</p>
<ol>
<li>要重新实现线程工厂的newThread方法，需要为线上加上 UncaughtExceptionHandler。</li>
<li>实现  UncaughtExceptionHandler 接口，定义个性化的需求。</li>
<li>覆盖ThreadPoolExecutor.afterExecute 方法。
以上，就能捕获线程池中线程的异常了。</li>
</ol>
<blockquote>
<p>Reference</p>
</blockquote>
<ol>
<li>http://www.blogjava.net/xylz/archive/2013/08/05/402405.html</li>
<li>http://stackoverflow.com/questions/1838923/why-is-uncaughtexceptionhandler-not-called-by-executorservice</li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ThreadPool/">ThreadPool</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java线程池/">java线程池</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/线程/">线程</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-testlatex" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/04/25/testlatex/" class="article-date">
  	<time datetime="2016-04-25T12:16:53.571Z" itemprop="datePublished">2016-04-25</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/25/testlatex/">hexo math example</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>\begin{aligned}
\phi(x,y) = \phi \left(\sum_{i=1}^n x_ie_i, \sum_{j=1}^n y_je_j \right)
= \sum_{i=1}^n \sum_{j=1}^n x_i y_j \phi(e_i, e_j)
\end{aligned}</p>
<p>$$\frac{\partial u}{\partial t}
= h^2 \left( \frac{\partial^2 u}{\partial x^2} +
\frac{\partial^2 u}{\partial y^2} +
\frac{\partial^2 u}{\partial z^2}\right)$$</p>
<p><span>$$\begin{aligned}
\dot{x} &amp; = \sigma(y-x) \\
\dot{y} &amp; = \rho x - y - xz \\
\dot{z} &amp; = -\beta z + xy
\end{aligned}$$</span><!-- Has MathJax --></p>
<p>\begin{aligned}
\dot{x} &amp; = \sigma(y-x) \
\dot{y} &amp; = \rho x - y - xz \
\dot{z} &amp; = -\beta z + xy
\end{aligned}</p>
<p>Simple inline $a = b + c$.</p>
<p><span>$$f(x1, x2) = \frac{ 1 }{2\pi \sigma1\sigma2\sqrt{1-r^2}}e^{-\frac{1}{2(1-r^2)} 
[\frac{(x1-\mu\_{x1})^2}{\sigma\_{x1}^2} - \frac{2r(x1-\mu\_{x1})(x2-\mu\_{x2})}{\sigma\_{x1} \sigma\_{x2}} + \frac{(x2-\mu\_{x2})^2}{\sigma\_{x2}^2}]}$$</span><!-- Has MathJax --></p>
<p><span>$$\begin{aligned}
  &amp; \phi(x,y) = \phi \left(\sum_{i=1}^n x_ie_i, \sum_{j=1}^n y_je_j \right)
  = \sum_{i=1}^n \sum_{j=1}^n x_i y_j \phi(e_i, e_j) = \\
  &amp; (x_1, \ldots, x_n) \left( \begin{array}{ccc}
      \phi(e_1, e_1) &amp; \cdots &amp; \phi(e_1, e_n) \\
      \vdots &amp; \ddots &amp; \vdots \\
      \phi(e_n, e_1) &amp; \cdots &amp; \phi(e_n, e_n)
    \end{array} \right)
  \left( \begin{array}{c}
      y_1 \\
      \vdots \\
      y_n
    \end{array} \right)
\end{aligned}$$</span><!-- Has MathJax --></p>
<p><span>$$\min { \quad \frac { 1 }{ 2 } \left\| w \right\| ^{ 2 }+c\sum _{ i=1 }^{ l }{ { \xi }_{ i } } } \\ st.\quad y_{ i }(\omega ^{ T }\phi (x_i)-b)\ge 1-\xi _{ i },\left( \xi _{ i }&gt;0 \right)$$</span><!-- Has MathJax --></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-hello-world" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/04/25/hello-world/" class="article-date">
  	<time datetime="2016-04-25T12:16:53.570Z" itemprop="datePublished">2016-04-25</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/25/hello-world/">Hello World</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2>Quick Start</h2>
<h3>Create a new post</h3>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure></p>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3>Run server</h3>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure></p>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3>Generate static files</h3>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure></p>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3>Deploy to remote sites</h3>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure></p>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-2015-01-15-use-mongo-map-reduce-statistic-word-occurrence" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/01/14/2015-01-15-use-mongo-map-reduce-statistic-word-occurrence/" class="article-date">
  	<time datetime="2015-01-14T04:51:00.000Z" itemprop="datePublished">2015-01-14</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/14/2015-01-15-use-mongo-map-reduce-statistic-word-occurrence/">使用mongodb内置的mapreduce聚合函数统计词频</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>有个需求需要对数据库中的某个字段进行频率统计，数据量较大，大概在2亿左右。</p>
<p>在之前先用一个简单的例子描述下问题。</p>
<p>比如我有一个mongo中的文档集合，比如说</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123; summary:&quot;This is good&quot; &#125;,</span><br><span class="line">    &#123; summary:&quot;This is bad&quot; &#125;,</span><br><span class="line">    &#123; summary:&quot;Something that is neither good nor bad&quot; &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">&gt;db.test.insert(&#123; summary:&quot;This is good&quot; &#125;);</span><br><span class="line">&gt;db.test.insert(&#123; summary:&quot;This is bad&quot; &#125;;</span><br><span class="line">&gt;db.test.insert(&#123; summary:&quot;Something that is neither good nor bad&quot; &#125;);</span><br></pre></td></tr></table></figure></p>
<p>现在要统计每个单词的出现次数，忽略大小写，最后按照升序排序，就像这样：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &quot;is&quot;: 3,</span><br><span class="line">    &quot;bad&quot;: 2,</span><br><span class="line">    &quot;good&quot;: 2,</span><br><span class="line">    &quot;this&quot;: 2,</span><br><span class="line">    &quot;neither&quot;: 1,</span><br><span class="line">    &quot;nor&quot;: 1,</span><br><span class="line">    &quot;something&quot;: 1,</span><br><span class="line">    &quot;that&quot;: 1</span><br><span class="line">]</span><br></pre></td></tr></table></figure></p>
<p>所以我们可以使用mongo中自带的聚合函数框架——mapreduce，然后我们自己根据需求
写个map函数和reduce函数就可以了。</p>
<p>&lt;!-- more --&gt;</p>
<p>关于<a href="http://docs.mongodb.org/manual/core/map-reduce/" target="_blank" rel="external">Map-Reduce</a>可以看到更加
详细的介绍，尤其适用于服务器端的文档处理率操作。</p>
<p>然后看是map函数，每个doc会传给这个<code>map</code>函数，这个这个函数会查找<code>summary</code>这个字段，若存在，则变小写，根据空格分割字符串，每个字置为1.</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> map = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;  </span><br><span class="line">    <span class="keyword">var</span> summary = <span class="keyword">this</span>.summary;</span><br><span class="line">    <span class="keyword">if</span> (summary) &#123; </span><br><span class="line">        <span class="comment">// quick lowercase to normalize per your requirements</span></span><br><span class="line">        summary = summary.toLowerCase().split(<span class="string">" "</span>); </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = summary.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            <span class="comment">// might want to remove punctuation, etc. here</span></span><br><span class="line">            <span class="keyword">if</span> (summary[i])  &#123;      <span class="comment">// make sure there's something</span></span><br><span class="line">               emit(summary[i], <span class="number">1</span>); <span class="comment">// store a 1 for each word</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>然后在写<code>reduce</code>函数，它是把<code>map</code>函数得到的结果加起来，并最终返回每个字的结果。</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> reduce = <span class="function"><span class="keyword">function</span>(<span class="params"> key, values </span>) </span>&#123;    </span><br><span class="line">    <span class="keyword">var</span> count = <span class="number">0</span>;    </span><br><span class="line">    values.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">v</span>) </span>&#123;            </span><br><span class="line">        count +=v;    </span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最后命令行执行</p>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;db.test.mapReduce(map, reduce, &#123;out: <span class="string">"word_count"</span>&#125;)</span><br><span class="line">&gt;db.word_count.find().sort(&#123;value：-1&#125;)</span><br></pre></td></tr></table></figure></p>
<p>即可看到结果，如下所示：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : &quot;is&quot;, &quot;value&quot; : 3 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : &quot;bad&quot;, &quot;value&quot; : 2 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : &quot;good&quot;, &quot;value&quot; : 2 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : &quot;this&quot;, &quot;value&quot; : 2 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : &quot;neither&quot;, &quot;value&quot; : 1 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : &quot;or&quot;, &quot;value&quot; : 1 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : &quot;something&quot;, &quot;value&quot; : 1 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : &quot;that&quot;, &quot;value&quot; : 1 &#125;</span><br></pre></td></tr></table></figure></p>
<h3>统计重复字段</h3>
<p>比如说要统计<code>taobao_id</code>这个字段，其他字段在这里用<code>summary</code>代指，这里面有的doc没有<code>taobao_id</code>字段，有的为空，这种情况会随软件版本升级出现类似情况。</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;summary&quot; : &quot;this is good&quot;, &quot;taobao_id&quot; : &quot;ad23x@#sa&quot; &#125;</span><br><span class="line">&#123; &quot;summary&quot; : &quot;this is bad&quot;, &quot;taobao_id&quot; : &quot;ad23x@#sa&quot; &#125;</span><br><span class="line">&#123; &quot;summary&quot; : &quot;this is holy shit!&quot;, &quot;taobao_id&quot; : &quot;ad23x@#2323sa&quot; &#125;</span><br><span class="line">&#123; &quot;summary&quot; : &quot;you are so fucking clever&quot;, &quot;taobao_id&quot; : &quot;ad123x@#2323sa&quot; &#125;</span><br><span class="line">&#123; &quot;summary&quot; : &quot;you r idiot&quot;, &quot;taobao_id&quot; : &quot;&quot; &#125;</span><br><span class="line">&#123; &quot;summary&quot; : &quot;it is deliciouse&quot; &#125;</span><br></pre></td></tr></table></figure></p>
<p><code>map</code>函数如下:</p>
<p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> map = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> taobao_id = <span class="keyword">this</span>.taobao_id;</span><br><span class="line">    <span class="comment">// make sure there is the field.</span></span><br><span class="line">    <span class="keyword">if</span>(taobao_id)</span><br><span class="line">    	<span class="comment">// store a 1 for this taobao_id</span></span><br><span class="line">        emit(taobao_id,<span class="number">1</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><code>reduce</code>函数如下：</p>
<p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> reduce = <span class="function"><span class="keyword">function</span>(<span class="params">key,values</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> count = <span class="number">0</span>;</span><br><span class="line">    values.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">v</span>)</span>&#123;</span><br><span class="line">        count+=v;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>结果如下：</p>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.so.mapReduce(map,reduce,&#123;out:<span class="string">"taobao_id_count"</span>&#125;)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"result"</span> : <span class="string">"taobao_id_count"</span>,</span><br><span class="line">	<span class="string">"timeMillis"</span> : 58,</span><br><span class="line">	<span class="string">"counts"</span> : &#123;</span><br><span class="line">		<span class="string">"input"</span> : 6,</span><br><span class="line">		<span class="string">"emit"</span> : 4,</span><br><span class="line">		<span class="string">"reduce"</span> : 1,</span><br><span class="line">		<span class="string">"output"</span> : 3</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">"ok"</span> : 1,</span><br><span class="line">&#125;</span><br><span class="line">&gt; db.taobao_id_count.<span class="function"><span class="title">find</span></span>()</span><br><span class="line">&#123; <span class="string">"_id"</span> : <span class="string">"ad123x@#2323sa"</span>, <span class="string">"value"</span> : 1 &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : <span class="string">"ad23x@#2323sa"</span>, <span class="string">"value"</span> : 1 &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : <span class="string">"ad23x@#sa"</span>, <span class="string">"value"</span> : 2 &#125;</span><br></pre></td></tr></table></figure></p>
<p>在服务器上运行得到
如下结果</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&quot;result&quot; : &quot;taobao_id_count&quot;,</span><br><span class="line">   &quot;counts&quot; : &#123;</span><br><span class="line">       &quot;input&quot; : NumberLong(166299476),</span><br><span class="line">       &quot;emit&quot; : NumberLong(98911196),</span><br><span class="line">       &quot;reduce&quot; : NumberLong(2492253),</span><br><span class="line">       &quot;output&quot; : NumberLong(95269211)</span><br><span class="line">   &#125;,</span><br></pre></td></tr></table></figure></p>
<p>字段说明：
总共存在有1.6亿个doc（其实这个数还是不准，多谢俊德指出db.device.count()的个数为227186295）；</p>
<p>其中存在taobao_id的doc数为98911196个；</p>
<p>总共规约的个数（即taobao_id重复的个数大于1的）为2492253个；</p>
<p>最后的结果有95269211个。</p>
<p>没有taobao_id的doc数大约为7千万。</p>
<p>重复的taobao_id个数为使用如下命令得出，大约花费1分钟
db.taobao_id_count.count({&quot;value&quot;:{$gt:1}})
2234285</p>
<p>结果验证：
db.taobao_id_count.find({&quot;value&quot;:2})
得到一堆在重复个数为2的taobao_id集合。
在重复个数为2的taobao_id中，用它的taobao_id在device总集中查找，看返回结果是否为两个。db.device.find({&quot;taobao_id&quot;:&quot;+/quUacD9KYQAAcmQQglxvvO&quot;})
结果只有两个结果</p>
<blockquote>
<blockquote>
<p>Referrence</p>
</blockquote>
</blockquote>
<ol>
<li>
<p><a href="http://docs.mongodb.org/manual/tutorial/write-scripts-for-the-mongo-shell/" target="_blank" rel="external">write scripts for the mongo shell</a></p>
</li>
<li>
<p><a href="http://jackyrong.iteye.com/blog/1408548" target="_blank" rel="external">快速例子学习mongodb的mapreduce</a></p>
</li>
<li>
<p><a href="http://stackoverflow.com/questions/16174591/mongo-count-the-number-of-word-occurences-in-a-set-of-documents" target="_blank" rel="external">词频统计</a></p>
</li>
<li>
<p><a href="http://docs.mongodb.org/manual/core/map-reduce/" target="_blank" rel="external">map reduce</a></p>
</li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/mongodb-map-reduce/">mongodb map-reduce</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-2014-09-02-qian-tan-wei-bo-biao-qian-ju-he" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/09/02/2014-09-02-qian-tan-wei-bo-biao-qian-ju-he/" class="article-date">
  	<time datetime="2014-09-01T15:47:00.000Z" itemprop="datePublished">2014-09-02</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/09/02/2014-09-02-qian-tan-wei-bo-biao-qian-ju-he/">浅谈微博标签聚合</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>标注问题在机器学习中是一个监督学习的问题，当然在这里我们所要面对是微博中用户给自己添加标签的
问题，并不是研究如何给用户添加标签。
浏览微博中用户的个人资料时，你会发现大部分用户都给自己添加了自认为所属类别的标签，这个很正确，
属于人工标注的典例。但是，细细浏览下每个人的标签我们会发现，其实好多标签的意思是一样的，比如
<code>苹果</code>，<code>iphone</code>，<code>iphone5</code>，的意思是类似的，还有<code>安卓</code>,<code>Android</code>,<code>智能手机</code>，<code>安卓手机</code>,
很明显，他们又是类，有没有办法把类似的标签聚集在一起呢？</p>
<p>直到现在，从我们的需求出发可以看到这是一个聚类问题，将相似的标签聚集到一起，并找出可以代表这
类相似标签的标签。</p>
<p>整体思路是根据用户的标签数据集得到“标签-用户”矩阵，考录到这个矩阵大部分为0值，所以使用稀疏矩阵
来降低内存无用消耗。然后使用一个相似度来代表距离，可以使用cosine相似度，pearson相似度，等等，
在这里使用的是余弦相似度，使用这里的算法进行聚类之后，得到聚类模型，如图所示。</p>
<p>接下来就是找到相似的标签，这个我们可以想象，从根节点开始，离根节点越远的拥有共同祖先的叶节点相似
越大，每个内节点都有一个代表它孩子的相似度，我们需要做的是，找到一个cutoff，然后，只要某个节点
小于该cutoff，那么认为他们之前没有相似关系，若大于改值，则意味这以改节点为祖先的叶节点是一个
簇，简单实用，而且效果不错。</p>
<p>到现在为止，我们找到了相似的标签集合，那么如何从集合中找到代表性的标签呢？一个显而易见的就是，计算
该标签被用户引用的次数，简单的总是最好的！</p>
<p>如图所示，这是按照上述思路完成的结果的一部分显示结果，数据太多，不方便显示。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/机器学习-微博标签-层次聚类/">机器学习 微博标签 层次聚类</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-2014-07-12-use-svm-to-classify-whether-a-person-is-good-or-bad-on-credit-using-sns-data" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/07/12/2014-07-12-use-svm-to-classify-whether-a-person-is-good-or-bad-on-credit-using-sns-data/" class="article-date">
  	<time datetime="2014-07-12T08:21:00.000Z" itemprop="datePublished">2014-07-12</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/07/12/2014-07-12-use-svm-to-classify-whether-a-person-is-good-or-bad-on-credit-using-sns-data/">use svm to classify whether a person is good or bad on credit using sns data</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>首先说明这只是一个思路方向性的大概说明介绍，更多关于业务方面的内容不方便介绍。</p>
<p>如何评价一个人的金融信用，这个可以搜集用户的一些基本数据，比如职业，大学，社交数据来进行评分判断，至于为什么选取这些特征，一个很显然的理由就是
一个人越倾向使用社交应用，那么这个人就越可能是真实的，可信的。职业学校和人的信用也是成一定关系但不是绝对就是向我们想当然的那样。</p>
<p>之前的文章也断断续续的聊过伪匹配，分类的内容，是和此有一定关联。</p>
<p>对于模型的构建，方式有很多，贝叶斯网络，逻辑回归模型，svm模型，甚至是神经网络模型都可以对此进行建模使用，但是哪个性能更好呢？不知道，只有分别做出之后
比较才可以说明问题。</p>
<p>&lt;!-- more --&gt;</p>
<h4>非线性SVM</h4>
<p>前面的blog有讲到线性svm，对于非线性分类器就要把x映射到特征空间,同时考虑误差ε的存在（即有些样本点会越过分类边界），上述优化问题变为：</p>
<p><span>$\min { \quad \frac { 1 }{ 2 } \left\| w \right\| ^{ 2 }+c\sum _{ i=1 }^{ l }{ { \xi  }_{ i } }  } \\ st.\quad y_{ i }(\omega ^{ T }\phi (x_i)-b)\ge 1-\xi _{ i },\left( \xi _{ i }&gt;0 \right)$</span><!-- Has MathJax --></p>
<p>从输入空间是映射到特征空间的函数称为核函数，LibSVM中使用的默认核函数是RBF（径向基函数radial basis function），即</p>
<p><span>$K(x,y)=exp{ \left( \frac { -\left\| x-y \right\| ^{ 2 } }{ 2\sigma ^{ 2 } }  \right)  }$</span><!-- Has MathJax --></p>
<p>这样一来就有两个参数需要用户指定：c和gamma。实际上在LibSVM中用户需要给出一个c和gamma的区间，
LibSVM采用交叉验证cross-validation accuracy的方法确定分类效果最好的c和gamma。</p>
<p>举个例子说明什么是交叉验证，假如把训练样本集拆成三组，然后先拿 1 跟 2 来 train model 并 predict 3 以得到正确率；
再来拿 2 跟 3 train 并 predict 1 ，最后 1,3 train 并 predict 2 ，最后取预测精度最高的那组c和gamma。</p>
<h4>libsvm</h4>
<p>点击<a href="http://www.csie.ntu.edu.tw/~cjlin/cgi-bin/libsvm.cgi?+http://www.csie.ntu.edu.tw/~cjlin/libsvm+tar.gz" target="_blank" rel="external">here</a>下载libsvm.</p>
<p>看readme即可使用了。</p>
<p>LibSVM要求处理的文件数据都满足如下格式：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rlabel1 index1:value1   index2:value2   …...</span><br><span class="line">rlabel2 index1:value1   index2:value2   …...</span><br></pre></td></tr></table></figure></p>
<p>rlabel表示分类，为一个数字。Index从1开始递增，表示输入向量的序号，value是输入向量相应维度上的值，如果value为0,该项可以不写。下面是一个示例文件：</p>
<p>目前简单的分类所使用的属性有：年龄WOE   类型WOE   信用卡邮箱授权WOE  搜多引擎返回数WOE  贴吧搜索返回数WOE  微博数WOE  活跃度WOE  淘友朋友WOE 人人看过的人数WOE  好友数WOE  微博注册时间WOE
预测值为还款情况（还款1，逾期0）</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0 1:0.010003 2:-0.10524 3:0.131117521 4:0.061095504 5:0.029130009 6:-0.178635093 7:-0.149465309 8:-0.03275873 9:-0.047039163 10:-0.047039163 11:-0.158328769</span><br><span class="line">0 1:0.010003 2:-0.10524 3:0.131117521 4:-0.025995297 5:-0.051360537 6:-0.090148625 7:-0.149465309 8:-0.005168969 9:0.000132475 10:-0.050262447 11:-0.158328769</span><br><span class="line">0 1:-0.08606 2:-0.10524 3:0.131117521 4:-0.163782716 5:-0.051360537 6:-0.178635093 7:-0.149465309 8:-0.03275873 9:-0.047039163 10:-0.047039163 11:-0.158328769</span><br><span class="line">0 1:-0.21088 2:0.009167 3:0.131117521 4:0.061095504 5:0.029130009 6:-0.090148625 7:-0.129577755 8:-0.03275873 9:0.000132475 10:-0.050262447 11:-0.226676962</span><br></pre></td></tr></table></figure></p>
<p>svm_scale用于把输入向量按列进行规范化（或曰缩放）。</p>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Usage: svm-scale [options] data_filename</span><br><span class="line">options:</span><br><span class="line"><span class="_">-l</span> lower : x scaling lower <span class="built_in">limit</span> (default -1)</span><br><span class="line">-u upper : x scaling upper <span class="built_in">limit</span> (default +1)</span><br><span class="line">-y y_lower y_upper : y scaling limits (default: no y scaling)</span><br><span class="line"><span class="_">-s</span> save_filename : save scaling parameters to save_filename</span><br><span class="line">-r restore_filename : restore scaling parameters from restore_filename</span><br></pre></td></tr></table></figure></p>
<p>例如： <code>svm_scale -l 0 -u 1 -s range trainSet &gt; trainSet.scale</code>则输入文件是trainSet，输出文件是trainSet.scale，把输入向量的各列都缩放到[0，1]的范围内，range文件中保存了相关的缩放信息。</p>
<p>这个时候我们应该把训练集分为两部分，训练集和测试集，在训练集上通过交叉验证学到最佳的参数，然后在测试集上验证。</p>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$python</span> subset.py</span><br><span class="line">Usage: subset.py [options] dataset number [output1] [output2]</span><br><span class="line">This script selects a subset of the given data set.</span><br><span class="line">options:</span><br><span class="line"><span class="_">-s</span> method : method of selection (default 0)</span><br><span class="line"></span><br><span class="line">     0 -- stratified selection (classification only)</span><br><span class="line"></span><br><span class="line">     1 -- random selection</span><br><span class="line"></span><br><span class="line">output1 : the subset (optional)</span><br><span class="line"></span><br><span class="line">output2 : the rest of data (optional)</span><br><span class="line"></span><br><span class="line">If output1 is omitted, the subset will be printed on the screen.</span><br><span class="line"></span><br><span class="line"><span class="variable">$python</span> subset.py trainSet 0.3*m(实例个数) trainSet.data <span class="built_in">test</span>Set.data</span><br><span class="line">$ ./tools/subset.py ./trainningset.txt 280 <span class="built_in">test</span>Set trainSet</span><br></pre></td></tr></table></figure></p>
<p>grid.py是一种用于RBF核函数的C-SVM分类的参数选择程序。用户只需给定参数的一个范围，grid.py采用交叉验证的方法计算每种参数组合的准确度来找到最好的参数。</p>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">python grid.py</span><br><span class="line">Usage: grid.py [-log2c begin,end,step] [-log2g begin,end,step] [-v fold]</span><br><span class="line">       [-svmtrain pathname] [-gnuplot pathname] [-out pathname] [-png pathname]</span><br><span class="line">       [additional parameters <span class="keyword">for</span> svm-train] dataset</span><br><span class="line">The program conducts v-fold cross validation using parameter C (<span class="keyword">and</span> gamma)= <span class="number">2</span>^begin, <span class="number">2</span>^(begin+step), ..., <span class="number">2</span>^end.</span><br></pre></td></tr></table></figure></p>
<p>首先<code>sudo apt-get install gnuplot</code></p>
<p>然后编译C++版本的LibSVM，生成svm-train二进制可执行文件。</p>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python grid.py -log2c -5,5,1 -log2g -4,0,1 -v 5 -svmtrain /path/to/your/svm-train -m 500 trainSet.data (svm-train 的路径自个找好)</span><br></pre></td></tr></table></figure></p>
<p>-m 500是使用svm_train时可以使用的参数。
最后输出两个文件：dataset.png绘出了交叉验证精度的轮廓图，dataset.out对于每一组log2(c)和log2(gamma)对应的CV精度值。</p>
<p>得到c=16，g=1</p>
<p>这个是我实验的截图</p>
<p><img src="https://raw.githubusercontent.com/aluenkinglee/mlclass/master/libsvm-3.18/trainSet.png" alt="实验截图"></p>
<p>最后来训练我们的模型</p>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ ./svm_train</span><br><span class="line"></span><br><span class="line"><span class="_">-s</span> svm_<span class="built_in">type</span> : <span class="built_in">set</span> <span class="built_in">type</span> of SVM (default 0)</span><br><span class="line">0 -- C-SVC</span><br><span class="line">-t kernel_<span class="built_in">type</span> : <span class="built_in">set</span> <span class="built_in">type</span> of kernel <span class="keyword">function</span> (default 2)</span><br><span class="line">0 -- linear: u<span class="string">'*v</span><br><span class="line">2 -- radial basis function: exp(-gamma*|u-v|^2)</span><br><span class="line">-g gamma : set gamma in kernel function (default 1/num_features) num_features是输入向量的个数</span><br><span class="line">-c cost : set the parameter C of C-SVC, epsilon-SVR, and nu-SVR (default 1)</span><br><span class="line">-m cachesize : set cache memory size in MB (default 100) 使用多少内存</span><br><span class="line">-e epsilon : set tolerance of termination criterion (default 0.001) </span><br><span class="line">-h shrinking : whether to use the shrinking heuristics, 0 or 1 (default 1) </span><br><span class="line">-wi weight : set the parameter C of class i to weight*C, for C-SVC (default 1) 当各类数量不均衡时为每个类分别指定C</span><br><span class="line">-v n: n-fold cross validation mode交叉验证时分为多少组</span><br><span class="line">-q : quiet mode (no outputs)</span><br><span class="line"></span><br><span class="line">$ svm_train -s 0 -c 16 -t 2 -g 1 -e 0.01 trainSet.scale</span><br><span class="line">$ ./svm-train -s 2 -c 16 -g 1 -v 5 ./trainSet</span></span><br></pre></td></tr></table></figure></p>
<p>会得到训练结果，然后使用这个模型来预测测试集的数据准确性</p>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./svm-predict <span class="built_in">test</span>Set result</span><br><span class="line">./svm-predict -b 0 <span class="built_in">test</span>Set trainSet.model  result</span><br></pre></td></tr></table></figure></p>
<h3>实验结果</h3>
<p>对数据进行格式转换后，首先对数据集进行分割得到训练集和测试集，选择常规比例为6：4</p>
<p>1.一开始未设置最有参数时即C和simga的值时，由训练集得到的模型分类性能在测试集上达到了Accuracy = 79.64285714285714% (223/280)的精度。</p>
<p>2.选择合适的参数。</p>
<p>通过交叉验证方法对模型进行选择得到针对训练集上最优的参数为c=16 g=1</p>
<p>由此得到的训练模型在测试集上的准确率达到了Accuracy = 81.4286% (228/280) (classification)，将近2%的精度提升，也算不错了。</p>
<p>目前由这些属性判断用户的还款情况，准确率在80%左右。但是预测结果全部预测为1.不合理。</p>
<p>实验结果准确率，在指定one-vs-class 之后，准确率为40%。比起逻辑回归模型仍然好点。</p>
<blockquote>
<blockquote>
<p>Ref</p>
</blockquote>
</blockquote>
<p>数据可以到<a href="https://github.com/aluenkinglee/mlclass/tree/master/libsvm-3.18" target="_blank" rel="external">这里</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/机器学习-svm-金融信用-libsvm/">机器学习 svm 金融信用 libsvm</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-2014-07-09-wei-pi-pei" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/07/09/2014-07-09-wei-pi-pei/" class="article-date">
  	<time datetime="2014-07-09T08:13:00.000Z" itemprop="datePublished">2014-07-09</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/07/09/2014-07-09-wei-pi-pei/">伪匹配</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>这里提到的伪匹配的概念是指在网上搜索某些特征词，比如人名公司手机QQ号等内容时，网页反馈的结果：重要关键词在人看来是逻辑没有关联的时候就是伪匹配。</p>
<p>比如说，某XX，公司名，地点很明显的构成一个记录的时候，在人看来是个写在一起的，那么结果就是匹配的。相反，要是搜索词相距很远，那么就是伪匹配。</p>
<p>那么好，人工审核此类内容是否匹配时，是个无聊枯燥的工作内容，那么只好找机器帮忙，思路也很简单，分析样本伪匹配的原因是什么？和网页文档有什么不同？</p>
<p>对目标网页的分析可以发现，搜索词在目标网页中有时是结构化存在的，就是搜索词处在不同的节点中，节点关系为树中的关系，或者是兄弟关系，或者是父子关系。
同时还有非结构化的内容，比如搜索词是在同一个节点中，此时就不存在上述判断关系，只能由另外一种关系来处理。
&lt;!-- more --&gt;
接着说，当是结构化的关系的时候，从我们人的观点来看，他们应该是兄弟节点，相邻很近，或者用另外一个距离：节点到最近祖先再到另外一个节点的距离。此距离也是很近的。</p>
<p>当时非结构话的关系时，他们是在用一语意范围内，所以字符距离很近。</p>
<p>OK，有了上面的思路，我们所做的就是分析统计目标网页的结构，然后查看具体指标的范围。</p>
<p>首先看如何区分是否结构化，这个可以依靠text的长度来判断（这是分析后发现的）。</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">x1=[54,161,70,65,66,3369,101,50,167];</span><br><span class="line">y1=[1,1,1,1,1,1,1,1,1];</span><br><span class="line">x2=[114265,89406,137824,11300,14001,54575,108596,78197,67810,11948,8660,2677,103724,8686];</span><br><span class="line">y2=[0 0 0 0 0 0 0 0 0 0 0 0 0 0];</span><br><span class="line">figure ;</span><br><span class="line">plot(x1,y1,&apos;rx&apos;,&apos;MarkerSize&apos;,10);</span><br><span class="line">hold on;</span><br><span class="line">plot(x2,y2,&apos;bo&apos;,&apos;MarkerSize&apos;,10);</span><br></pre></td></tr></table></figure></p>
<p>数据是分析后得到的。</p>
<p>分布图如下：</p>
<p><img src="https://raw.githubusercontent.com/aluenkinglee/aluenkinglee.github.io/source/source/images/2014-07-09-wei-pi-pei/false%20match1.png" alt="是否结构化与最长文本长度分布图" title="是否结构化与最长文本长度分布图"></p>
<p>从图形分界出来看，max(x1)=3369,min(x2)=2677,这个cutoff可以选取2677～3369之间的长度即可。</p>
<p>代码如下,摘选了函数的一部分，url是函数的形参。</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    Document doc = Jsoup.connect(url).get();</span><br><span class="line">    Vector&lt;HashMap&lt;String, Integer&gt;&gt; map = <span class="keyword">new</span> Vector&lt;HashMap&lt;String, Integer&gt;&gt;();</span><br><span class="line">    Map&lt;String, Integer&gt; tagCount = <span class="keyword">new</span> HashMap&lt;String, Integer&gt;();</span><br><span class="line">    Map&lt;Integer, Integer&gt; lenCount = <span class="keyword">new</span> HashMap&lt;Integer, Integer&gt;();</span><br><span class="line">    Elements content = doc.getAllElements();</span><br><span class="line">    <span class="keyword">int</span> max = <span class="number">0</span>;</span><br><span class="line">    String tag = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (Element e : content) &#123;<span class="comment">// 此处就是遍历了</span></span><br><span class="line">        <span class="keyword">if</span> (e.ownText().length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            String key = e.nodeName();</span><br><span class="line">            <span class="keyword">int</span> len = e.ownText().length();</span><br><span class="line">            HashMap&lt;String, Integer&gt; ins = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">            ins.put(key, len);</span><br><span class="line">            map.add(ins);</span><br><span class="line">            <span class="keyword">if</span> (len &gt; max) &#123;</span><br><span class="line">                max = len;</span><br><span class="line">                tag = key;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (lenCount.containsKey(len)) &#123;</span><br><span class="line">                lenCount.put(len, lenCount.get(len) + <span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                lenCount.put(len, <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (tagCount.containsKey(key)) &#123;</span><br><span class="line">                tagCount.put(key, tagCount.get(key) + <span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                tagCount.put(key, <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(map);</span><br><span class="line">    System.out.println(tagCount);</span><br><span class="line">    System.out.println(lenCount);</span><br><span class="line">    System.out.println(tag + <span class="string">":"</span> + max);</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    <span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">    <span class="comment">// e.printStackTrace();</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接着在做搜索节点的距离值的分布，一个搜索词可以会出现在不同的位置，既然搜索词之间有关联效应，那么，即使出现位置很多，
也会有不同的搜索词因为语意关联的缘故，他们的节点距离是很近的，照这个思路，有了以下的分布图。</p>
<p>网页结构化中伪匹配,节点距离兄弟距离的分布图图示如下：</p>
<p><img src="https://raw.githubusercontent.com/aluenkinglee/aluenkinglee.github.io/source/source/images/2014-07-09-wei-pi-pei/false%20match3.png" alt="网页结构化中伪匹配节点距离兄弟距离的分布图" title="网页结构化中伪匹配节点距离兄弟距离的分布图"></p>
<p>这个尾部节点兄弟距离太大了，一定是伪匹配的的，看数据较小的距离分布。</p>
<p><img src="https://raw.githubusercontent.com/aluenkinglee/aluenkinglee.github.io/source/source/images/2014-07-09-wei-pi-pei/false%20match4.png" alt="网页结构化中伪匹配节点距离兄弟距离的分布图" title="网页结构化中伪匹配节点距离兄弟距离的分布图"></p>
<p>从图可以看出，节点距离和伪匹配的关系不大，主要是兄弟距离起作用。</p>
<p>而兄弟距离于未匹配的分布图：</p>
<p><img src="https://raw.githubusercontent.com/aluenkinglee/aluenkinglee.github.io/source/source/images/2014-07-09-wei-pi-pei/false%20match5.png" alt="兄弟距离于未匹配的分布图" title="兄弟距离于未匹配的分布图"></p>
<p>各个距离的直方图如下：</p>
<p><img src="https://raw.githubusercontent.com/aluenkinglee/aluenkinglee.github.io/source/source/images/2014-07-09-wei-pi-pei/false%20match6.png" alt="兄弟距离于未匹配的直方图" title="兄弟距离于未匹配的直方图"></p>
<p>其中X轴是兄弟距离长度，y是个数。范围值可以选在3-28之间。</p>
<p>而在无结构中，搜索词的语意判断就是文本距离，搜索词的下标靠的很近。图示如下：</p>
<p><img src="https://raw.githubusercontent.com/aluenkinglee/aluenkinglee.github.io/source/source/images/2014-07-09-wei-pi-pei/false%20match2.png" alt="间隔分布图" title="间隔分布图"></p>
<p>文本长度的数据（取一个网页中搜索词之间距离的最小值）为<code>4 13 25 58 89 102 249 893 1356 2000 2445 3023 4243 12533 13234</code>
,从这个可以看出，距离很大的肯定就是伪匹配了，最小值的这个不确定。</p>
<p>完整代码请看<a href="https://github.com/aluenkinglee/stuff/tree/master/java/match" target="_blank" rel="external">这里</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/数据挖掘，网页分析，-jsoup/">数据挖掘，网页分析， jsoup</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-2014-07-12-po-su-bei-xie-si-wen-ben-fen-lei" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/06/27/2014-07-12-po-su-bei-xie-si-wen-ben-fen-lei/" class="article-date">
  	<time datetime="2014-06-27T04:11:00.000Z" itemprop="datePublished">2014-06-27</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/06/27/2014-07-12-po-su-bei-xie-si-wen-ben-fen-lei/">朴素贝叶斯文本分类</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>回顾朴素贝叶斯(NB)分类器:</p>
<p><span>$$p(y_k|x)=\frac{p(y_k)p(x|y_k)}{p(x)}\propto p(y_k)p(x|y_k)=p(y_k)\prod_{i=1}^{d}{p(x_i|y_k)}$$</span><!-- Has MathJax --></p>
<p>对于文本分类任务,即对一篇文章进行分类,是 NLP 中最常见的机器学习任务。一般情况下,类别从几个到几十不等,或者更多。使用朴素贝叶斯文分类器进行文本分类,我们需要首先考虑特征是什么,即x如何表示;$p(x_i|y_k )$的物理意义是什么,如何计算。对于特征方面,文本分类常规都是使用 bag-of-words 的特征,即以文章中出现的词作为特征,而不考虑词语出现的顺序。朴素贝叶斯文分类器也一般使用这种形式。那么特征空间的大小,就取决于词表(vocabulary)的大小,即语料集合中不重复词的个数。对于汉语来说,一般几万到百万不等。</p>
<p>在 bag-of-words 的特征体系下,特征空间是确定了的,但是具体$x_i$的取值以及对应的$p(x_i |y_k )$的物理意义却可以有不同的考虑,对应着不同的参数计算公式及分类器训练和预测的实现。这取决于我们是否考虑词语在文章中出现的频次。</p>
<p>&lt;!-- more --&gt;</p>
<h4>伯努力(Bernoulli)NB</h4>
<p>先看不考虑词频的情况。即只看某词语在某文章中是否出现,而不管出现了具体是多少次。这种假设下,每维特征的取值为 0-1,此时对应的 NB 分类器又被称为伯努力(Bernoulli)NB 分类器。
比如,如果词表是{2014、年、巴西、世界杯、足球赛、举行、是、第、20、届、球队},某文档是“2014 年巴西世界杯足球赛是第 20 届世界杯足球赛 ”,那么特征空间是 11,该文档特征向量是:</p>
<p>$$
x = (1,1,1,1,1,0,1,1,1,1,0)
$$</p>
<p>此时,$p(x_i|y_k)$的物理意义可认为是:若文章为 k 类别,则第 i 特征(词表第 i 个词)出现或者不出现的概率。那么:
$$
p(x_i = 0|y_k ) = 1 − p(x_i = 1|y_k)
$$</p>
<p>习惯的,我们经常用$p(x_i |y_k )$来作为$p(x_i = 1|y_k)$同等含义的一种表示。那此时,原NB模型的表达式可以写为:</p>
<p><span>$$p\left( { { y }_{ k } }|{ x } \right) \propto 
p\left( { y }_{ k } \right) \prod _{ i=1 }^{ d }{ \left\{ { \alpha  }_{ i }p\left( { { x }_{ i } }|{ { y }_{ k } } \right) 
+\left( 1-{ \alpha  }_{ i } \right) \left( 1-p\left( { { x }_{ i } }|{ { y }_{ k } } \right)  \right)  \right\}  }$$</span><!-- Has MathJax --></p>
<p>$\alpha_i$ 表示第 i 个词在该文档中出现了,没出现则为0.此时要非常注意,计算文章属于某个类别的得分的时候,不只要考虑该文章的 word,还要考虑在词表中的但是在该文章中没出现的 word!这类词对得分的贡献是$1 − p(x_i |y_k )$。因此伯努力 NB 下,分类的时间复杂度是 $O(Cd)$,C 是类别数,d 是词表大小。</p>
<p>那么伯努力 NB 下,p的参数估计表达式是多少呢?假设根据如上定义,及最大似然估计,可以得到:</p>
<p><span>$$p\left( { { x }_{ i } }|{ { y }_{ k } } \right) 
=\frac { \sum _{ t=1 }^{ n }{ I\left\{ y_{ k }={ y }_{t } \right\} I\{ x_{ i }\quad in\quad y_{ t }\}  }  }{ \sum _{ t=1 }^{ t }{ I\left\{ y_{ k }={ y }_{ t } \right\}  }  }
=\frac { 特征词i在第k类文章中出现的文章数 }{ 第k类文章数 }$$</span><!-- Has MathJax --></p>
<p>其中函数I是指示函数，若x出现则值为1。可见,对于高频词,对应的这种条件概率是非常高的。 比如“的”(假设没去除停用词),其对应的条件概率值很可能会接近于 1.</p>
<p>再重复强调一下,此时的概率意义约束是: $p(x_i = 1|y_k) + p(x_i = 0|y_k ) = 1$</p>
<p>看一下伯努力 NB 下参数平滑的问题。使用加 1 平滑,即拉普拉斯平滑,此时在保证概率意义下,其平滑公式应该为:</p>
<p>$$
p(x_i |y_k ) = \frac{第 k 类文章中出现过第 i 词的文章数 + 1}{第k类文章数 + 2}
$$</p>
<p>提醒一下,此处分母加的值是 2,而不是词表大小。注意,平滑一定要使得平滑之后仍满足概率意义。</p>
<h4>多项式(Multinomial)NB</h4>
<p>当我们考虑文章内词语的频次,而不只是考虑出现或未出现,此时特征的取值不再是 0-1,不过总的特征空间大小仍未变化。拿前面的例子来做对照,词表是{2014、年、巴西、世界杯、足球赛、举行、是、第、20、届、球队},某文档是“2014 年巴西世界杯足球赛是第 20 届世界杯足球赛”,此时该文章的特征向量为:</p>
<p>$$
x = (1,1,1,2,2,0,1,1,1,1,0)
$$</p>
<p>此时对应的 NB 一般称为多项式 NB。设 m 为文章内的总词频数,对应的模型表达式应该如下:</p>
<p><span>$$p(y_k|x)&prop;p(y_k)p(x|y_k)=p(y_k)
\frac{m!}{\prod_{i=1}^{d} x_i!}
\prod_{i=1}^{d}p(w_i|y_k)^{x_i}
&prop;p(y_k)\prod_{i=1}^{d}p(w_i|y_k)^{x_i}$$</span><!-- Has MathJax --></p>
<p>之所以可以省掉这个多项式系数,是因为它是和类别$y_k$无关的。而此时,第 k 类别的所有文章中第 i 词的分布概率:</p>
<p><span>$$p\left( { { w }_{ i } }|{ { y }_{ k } } \right)
 =\frac { \sum _{ t=1 }^{ n }{ I\left\{ y_{ k }={ y }_{ t } \right\} x_{ i }^{ t } }  }
{ \sum _{ j=1 }^{ d }{ \sum _{ t=1 }^{ n }{ I\left\{ y_{ k }={ y }_{ t } \right\} x_{ i }^{ t } }  }  } 
=\frac { 特征词i在第k类文章中出现的总词频数 }{ 第k文章总词频数 }$$</span><!-- Has MathJax --></p>
<p>在多项式NB下,即使极高频词,其$p(w_i|y_k)$也很难接近于 1,另外其在模型中作用的时候是:$p(w_i|y_k)^{x_i}$.这时候的概率约束是:</p>
<p><span>$\sum_{i=1}^{d}p(w_i|y_k)=1$</span><!-- Has MathJax --></p>
<p>因此对应的加 1 平滑为:</p>
<p><span>$$p\left( { { w }_{ i } }|{ { y }_{ k } } \right) =\frac { \sum _{ t=1 }^{ n }{ I\left\{ y_{ k }={ y }_{ t } \right\} x_{ i }^{ t } } +1 }
{ \sum _{ j=1 }^{ d }{ \sum _{ t=1 }^{ n }{ I\left\{ y_{ k }={ y }_{ t } \right\} x_{ i }^{ t } }  }  +d}$$</span><!-- Has MathJax --></p>
<p>注意事项：</p>
<ul>
<li>
<p>训练时候对于词语平铺的文本,应该要做词的聚合,即行程 bag-of-words 的形式比较有利于后续统计计算,特别是对于伯努利 NB 必须做去重。当然,对于多项式 NB,也可以顺次扫描累加。</p>
</li>
<li>
<p>预测时候的概率连乘,为了防止精度损失,可以改用取 log 相加。</p>
</li>
<li>
<p>对于短一些的文本,伯努利 NB 即可;对于长文本,考虑词频的多项式 NB 即可。当然也可以使用 tf-idf 等特征值,仿照多项式 NB 的形式。</p>
</li>
<li>
<p>预测时候,对于词表中出现但是本文章未出现的词语,伯努利 NB 下对得分有贡献,多项式 NB 下不用考虑;对于在词表中未出现的词,都可以不予以考虑,因为未登录词对各个类别的贡献是一样的。</p>
</li>
</ul>
<h4>实验</h4>
<p>关于实验数据，可以到<a href="https://github.com/aluenkinglee/mlclass/tree/master/NativeBayes" target="_blank" rel="external">这里</a>下载，训练集和测试集都已经很明白
总量在4000-的水平，result.dat是训练结果，可以看到测试集在训练数据的结果上准确率达到了100%。。这个是因为类别太少的缘故。只有3个类别，不过这个已经
可以看到朴素贝叶斯在工业界的应用可以达到较好的性能。</p>
<p>朴素贝叶斯分类器代码：</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">     * 训练目录下的样本集合</span><br><span class="line">     * </span><br><span class="line">     * <span class="doctag">@throws</span> IOException</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">trainSamples</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        NaiveBayes classifier = <span class="keyword">new</span> NaiveBayes();</span><br><span class="line">        File flist = <span class="keyword">new</span> File(<span class="string">"./data-trainning-set"</span>);</span><br><span class="line">        <span class="keyword">for</span> (File f : flist.listFiles()) &#123;</span><br><span class="line">            classifier.training(<span class="keyword">new</span> Instance(f));</span><br><span class="line">        &#125;</span><br><span class="line">        classifier.save(<span class="keyword">new</span> File(<span class="string">"result.dat"</span>));</span><br><span class="line">        System.out.println(<span class="string">"Trainning finished"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * specify the training dataset directory, and store result in the outfile</span><br><span class="line">     * </span><br><span class="line">     * <span class="doctag">@param</span> directory</span><br><span class="line">     * <span class="doctag">@param</span> result</span><br><span class="line">     * <span class="doctag">@throws</span> IOException</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">trainSamples</span><span class="params">(String directory, String outfile)</span></span><br><span class="line">            <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        NaiveBayes classifier = <span class="keyword">new</span> NaiveBayes();</span><br><span class="line">        File flist = <span class="keyword">new</span> File(directory);</span><br><span class="line">        <span class="keyword">for</span> (File f : flist.listFiles()) &#123;</span><br><span class="line">            classifier.training(<span class="keyword">new</span> Instance(f));</span><br><span class="line">        &#125;</span><br><span class="line">        classifier.save(<span class="keyword">new</span> File(outfile));</span><br><span class="line">        System.out.println(<span class="string">"Trainning finished"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 判断该实例所属的类别category</span><br><span class="line">     * </span><br><span class="line">     * <span class="doctag">@param</span> doc</span><br><span class="line">     * <span class="doctag">@return</span></span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCategory</span><span class="params">(Instance doc)</span> </span>&#123;</span><br><span class="line">        Collection&lt;String&gt; categories = VARIABLE.getCategories();</span><br><span class="line">        System.out.println(categories);</span><br><span class="line">        <span class="keyword">double</span> best = Double.NEGATIVE_INFINITY;</span><br><span class="line">        String bestName = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (String c : categories) &#123;</span><br><span class="line">            <span class="keyword">double</span> current = getProbability(c, doc);</span><br><span class="line">            System.out.println(c + <span class="string">":"</span> + current);</span><br><span class="line">            <span class="keyword">if</span> (best &lt; current) &#123;</span><br><span class="line">                best = current;</span><br><span class="line">                bestName = c;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bestName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 计算P（C)=该类型文档总数/文档总数，返回的数对数值</span><br><span class="line">     * </span><br><span class="line">     * <span class="doctag">@param</span> category</span><br><span class="line">     * <span class="doctag">@return</span></span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getCategoryProbability</span><span class="params">(String category)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Math.log(VARIABLE.getDocCount(category) * <span class="number">1.0f</span></span><br><span class="line">                / VARIABLE.getDocCount());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 计算P(feature|cateogry),返回的是取对数后的数值</span><br><span class="line">     * </span><br><span class="line">     * <span class="doctag">@param</span> feature</span><br><span class="line">     * <span class="doctag">@param</span> category</span><br><span class="line">     * <span class="doctag">@return</span></span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getFeatureProbability</span><span class="params">(String feature, String category)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> m = VARIABLE.getFeatureCount();</span><br><span class="line">        <span class="keyword">return</span> Math.log((VARIABLE.getDocCount(feature, category) + <span class="number">1.0</span>)</span><br><span class="line">                / (VARIABLE.getDocCount(category) + m));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 计算给定实例文档属于指定类别的概率，返回的是取对数后的数值</span><br><span class="line">     * </span><br><span class="line">     * <span class="doctag">@param</span> category</span><br><span class="line">     * <span class="doctag">@param</span> doc</span><br><span class="line">     * <span class="doctag">@return</span></span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getProbability</span><span class="params">(String category, Instance doc)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">double</span> result = getCategoryProbability(category);</span><br><span class="line">        <span class="keyword">for</span> (String feature : doc.getWords()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (VARIABLE.containFeature(feature)) &#123;</span><br><span class="line">                result += getFeatureProbability(feature, category);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 加载训练结果</span><br><span class="line">     * </span><br><span class="line">     * <span class="doctag">@param</span> file</span><br><span class="line">     * <span class="doctag">@throws</span> IOException</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">(File file)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        DataInputStream in = <span class="keyword">new</span> DataInputStream(<span class="keyword">new</span> FileInputStream(file));</span><br><span class="line">        VARIABLE = Variable.read(in);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 保存训练结果</span><br><span class="line">     * </span><br><span class="line">     * <span class="doctag">@throws</span> IOException</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">(File file)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        DataOutput out = <span class="keyword">new</span> DataOutputStream(<span class="keyword">new</span> FileOutputStream(file));</span><br><span class="line">        VARIABLE.write(out);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 训练一篇文档</span><br><span class="line">     * </span><br><span class="line">     * <span class="doctag">@param</span> doc</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">training</span><span class="params">(Instance doc)</span> </span>&#123;</span><br><span class="line">        VARIABLE.addInstance(doc);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>特征词类代码：</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Feature</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** 每个关键词在不同类别中出现的文档数量 */</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Integer&gt; docCountMap = <span class="keyword">new</span> HashMap&lt;String, Integer&gt;();</span><br><span class="line">    <span class="comment">/** 特征名称 */</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">incDocCount</span><span class="params">(String category)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (docCountMap.containsKey(category)) &#123;</span><br><span class="line">            docCountMap.put(category, docCountMap.get(category) + <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            docCountMap.put(category, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getDocCount</span><span class="params">(String category)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (docCountMap.containsKey(category)) &#123;</span><br><span class="line">            <span class="keyword">return</span> docCountMap.get(category);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(DataOutput out)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        out.writeUTF(name == <span class="keyword">null</span> ? <span class="string">""</span> : name);</span><br><span class="line"></span><br><span class="line">        out.writeInt(docCountMap.size());</span><br><span class="line">        <span class="keyword">for</span> (String category : docCountMap.keySet()) &#123;</span><br><span class="line">            out.writeUTF(category);</span><br><span class="line">            out.writeInt(docCountMap.get(category));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readFields</span><span class="params">(DataInput in)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = in.readUTF();</span><br><span class="line"></span><br><span class="line">        docCountMap = <span class="keyword">new</span> HashMap&lt;String, Integer&gt;();</span><br><span class="line">        <span class="keyword">int</span> size = in.readInt();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">            String category = in.readUTF();</span><br><span class="line">            <span class="keyword">int</span> docCount = in.readInt();</span><br><span class="line">            docCountMap.put(category, docCount);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Feature <span class="title">read</span><span class="params">(DataInput in)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Feature f = <span class="keyword">new</span> Feature();</span><br><span class="line">        f.readFields(in);</span><br><span class="line">        <span class="keyword">return</span> f;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>更多代码请看<a href="https://github.com/aluenkinglee/mlclass/tree/master/NativeBayes/src" target="_blank" rel="external">这里</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/机器学习-朴素贝叶斯-文本分类/">机器学习 朴素贝叶斯 文本分类</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-2014-06-03-lagrange-duality" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/06/03/2014-06-03-lagrange-duality/" class="article-date">
  	<time datetime="2014-06-03T12:41:00.000Z" itemprop="datePublished">2014-06-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/06/03/2014-06-03-lagrange-duality/">拉格朗日对偶</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在解决约束最优化的额问题中，常常利用拉格朗日对偶性将原始问题转化为对偶问题，通过解对偶问题得到原始问题的解。该方法主要应用的SVM和最大熵模型中。</p>
<p>先抛开上面的二次规划问题，先来看看存在等式约束的极值问题求法，比如下面的最优化问题：</p>
<p><span>$\min _{ w }{ f\left( w \right)  } \\ s.t\quad h_{ i }\left( w \right) =0,\quad i=1,\cdots ,l$</span><!-- Has MathJax --></p>
<p>目标函数是f(w)，下面是等式约束。通常解法是引入拉格朗日算子，这里使用$$\beta$$来表示算子，得到拉格朗日公式为</p>
<p>&lt;!-- more --&gt;</p>
<p><span>$L \left( w,\beta  \right) =f\left( w \right) +\sum _{ i=1 }^{ l }{ \beta _{ i }h_{ i } } \left( w \right)$</span><!-- Has MathJax --></p>
<p>L是等式约束的个数。</p>
<p>然后分别对w和 $$\beta$$求偏导，使得偏导数等于0，然后解出w和 $\beta_i$。至于为什么引入拉格朗日算子可以求出极值，原因是f(w)
的dw变化方向受其他不等式的约束，dw的变化方向与f(w)的梯度垂直时才能获得极值，而且在极值处，f(w)的梯度与其他等式梯度的线性组合平行，因此他们之间存在线性关系。（参考《最优化与KKT条件》）
然后我们探讨有不等式约束的极值问题求法，问题如下：</p>
<p>$$
\min <em>{ w }{ f\left( w \right)  } \
s.t\quad h</em>{ i }\left( w \right) =0,\quad i=1,\cdots ,l\
\quad \quad \quad g_{ i }\left( w \right) \le 0,\quad i=1,\cdots ,k
$$</p>
<p>我们定义一般化的拉格朗日公式</p>
<p>$$
L\left( w,\beta  \right) =f\left( w \right) +\sum _{ i=1 }^{ k }{ \alpha <em>{ i }g</em>{ i } } \left( w \right) \sum _{ i=1 }^{ l }{ \beta <em>{ i }h</em>{ i } } \left( w \right)
$$</p>
<p>这里的$$\alpha _{ i } $$和$$\beta <em>{ i } $$ 都是拉格朗日算子。如果按这个公式求解，会出现问题，因为我们求解的是最小值，而这里的 $$g</em>{ i } \left( w \right) $$已经不是0了，我们可以将 $$\alpha _{ i } $$调整成很大的正值，来使最后的函数结果是负无穷。因此我们需要排除这种情况，我们定义下面的函数：</p>
<p>$$
{ \theta  }_{p  }\left( w \right) =\max <em>{ \alpha ,\beta :{ \alpha  }</em>{ i }\ge 0 }{ L\left( w,\alpha ,\beta  \right)  }
$$</p>
<p>这里的P代表primal。假设$$g_{ i }\left( w \right)$$ &gt;0 或者$$h_{ i }\left( w \right) \neq 0$$ ，那么我们总是可以调整 $$\alpha_i$$和$$\beta_i$$ 来使得$$ { \theta  }<em>{ p  }\left( w \right)$$有最大值为正无穷。而只有g和h满足约束时，$$ { \theta  }</em>{ p }\left( w \right)$$ 为f(w)。这个函数的精妙之处在于 $$\alpha_i \ge 0$$，而且求极大值。</p>
<p>因此,</p>
<p>$$
{ \theta  }_{ p  }\left( w \right) =\begin{cases} f\left( w \right) ,\quad w满足原始问题约束 \ +\infty ，其他\quad  \end{cases}
$$</p>
<p>所以如果考虑极小化问题</p>
<p>$$
{ \min <em>{ w }{ { \theta  }</em>{p  }\left( w \right)  }  }={ \min _{ w }{ \max <em>{ \alpha ,\beta :{ \alpha  }</em>{ i }\ge 0 }{ L\left( w,\alpha ,\beta  \right)  }  }  }
$$</p>
<p>它是原始问题的等价解，原始最优化问题转化成了拉格朗日函数的极小极大问题，这时候把原始问题的最优值记为：</p>
<p>$$
{ p }^{ \ast  }=\min <em>{ w }{ { \theta  }</em>{ p }\left( w \right)  }
$$</p>
<p>哎哟，看看我们的等价形式哦，首先有两个参数，其中还是一个不等式约束=。=,考虑下对偶吧，极小极大问题转化为等价的极大极小问题。</p>
<p>####对偶形式</p>
<p>定义$${ \theta  }_{ D }\left( \alpha ,\beta  \right) =\min <em>{ w }{ L\left( w,\alpha ,\beta  \right)  } $$，在考虑极大化$${ \theta  }</em>{ D }\left( \alpha ,\beta  \right) $$,先把这两个参数看成固定值，求关于w的最小值，之后在求对偶的最大值即</p>
<p>$$
\max <em>{ \alpha ,\beta :{ \alpha  }</em>{ i }\ge 0 }{ { \theta  }_{ D }\left( \alpha ,\beta  \right)  } =\max <em>{ \alpha ,\beta :{ \alpha  }</em>{ i }\ge 0 }{ \min _{ w }{ L\left( w,\alpha ,\beta  \right)  }  }
$$</p>
<p>这个问题是原问题的对偶问题，相对于原问题只是更换了min和max的顺序，而一般更换顺序的结果是Max Min(X) &lt;= MinMax(X)。然而在这里两者相等。用$${ d }^{ \ast  }$$ 来表示对偶问题如下：</p>
<p>$$
{ d }^{ \ast  }=\max <em>{ \alpha ,\beta :{ \alpha  }</em>{ i }\ge 0 }{ \min _{ w }{ L\left( w,\alpha ,\beta  \right)  }  } \le { \min _{ w }{ \max <em>{ \alpha ,\beta :{ \alpha  }</em>{ i }\ge 0 }{ L\left( w,\alpha ,\beta  \right)  }  }  }={ p }^{ \ast  }
$$</p>
<p>存在 $${ w }^{ \ast  },{ \alpha }^{ \ast  },{ \beta }^{ \ast  }$$ 使得$${ w }^{ \ast  }$$是原问题的解，$${ \alpha }^{ \ast  },{ \beta }^{ \ast  }$$  是对偶问题的解。还有 $${ p }^{ \ast  }={ d}^{ \ast  } = L({ w }^{ \ast  },{ \alpha }^{ \ast  },{ \beta }^{ \ast  })$$</p>
<p>另外，  $${ w }^{ \ast  },{ \alpha }^{ \ast  },{ \beta }^{ \ast  }$$ 满足库恩-塔克条件（Karush-Kuhn-Tucker, KKT condition），该条件如下：</p>
<p>![库恩-塔克条件（Karush-Kuhn-Tucker, KKT condition）](https://github.com/aluenkinglee/aluenkinglee.github.io/blob/source/source/images/2014-06-03-lagrange-duality/kkt.png?raw=true 库恩-塔克条件（Karush-Kuhn-Tucker, KKT condition）&quot;)</p>
<p>所以如果 $${ w }^{ \ast  },{ \alpha }^{ \ast  },{ \beta }^{ \ast  }$$  满足了库恩-塔克条件，那么他们就是原问题和对偶问题的解。当$$g_{i}(w^{ \ast  })=0$$ 时，w处于可行域的边界上，这时才是起作用的约束。而其他位于可行域内部（ $$g_{i}(w^{ \ast  })&lt;0$$ 的）点都是不起作用的约束，其 $${ \alpha }^{ \ast  }=0$$。这个KKT双重补足条件会用来解释支持向量和SMO的收敛测试。</p>
<p>KKT的总体思想是将极值会在可行域边界上取得，也就是不等式为0或等式约束里取得，而最优下降方向一般是这些等式的线性组合，其中每个元素要么是不等式为0的约束，要么是等式约束。对于在可行域边界内的点，对最优解不起作用，因此前面的系数为0。</p>
<blockquote>
<blockquote>
<p>参考</p>
</blockquote>
</blockquote>
<ol>
<li>
<p>Andrew Ng的原始课件讲义</p>
</li>
<li>
<p>统计学习方法</p>
</li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/机器学习-拉格朗日对偶/">机器学习 拉格朗日对偶</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-2014-06-03-my-understanding-about-svm" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/06/03/2014-06-03-my-understanding-about-svm/" class="article-date">
  	<time datetime="2014-06-03T11:53:00.000Z" itemprop="datePublished">2014-06-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/06/03/2014-06-03-my-understanding-about-svm/">从逻辑回归分类到SVM分类</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>上一章讲到了线性回归的一个典型算法，核心思想就是利用最小二乘法最为损失函数，不断使用梯度下降法（或者使用随机梯度下降法（stochastic gradient descent））来更新theta值。</p>
<p>后来降到了分类，逻辑回归只不过有个很好的性质就是值分布在0到1之间，正好可以利用到分类上。logistic回归就是要学习得到θ，使得正例的特征远大于 0，负例的特征远
小于 0，强调在全部训练实例上达到这个目标。为什么说逻辑回归是个线性模型？这是因为该模型是将特性的线性组合作为自变量，然后使用logistic函数（或者说是sigmoid函数）将自变量映射到（0-1）上，将值和概率结合之后从而应用到分类上。
函数表示形式：</p>
<p>$$
h_{ \theta  }\left( x \right) =g\left( \theta ^{ T }x \right) =\frac { 1 }{ 1+{e  }^{ -\theta^{T}x } }
$$</p>
<p>&lt;!-- more --&gt;</p>
<p>其中 x 是 n 维特征向量，函数 g 就是 logistic 函数
从线性回归到了逻辑回归，从逻辑回归又到了分类，那么再来看看SVM这个有监督的分类学习算法。
在这里我们使用的y的取值记为1和-1，所以对logistic 回归中的做下替换，令logistic回归中的y=0和y=1变为y=-1,y=1。同时将θ替换成 w 和 b。
所以有$$\Theta^{T}x=\theta_0x_0+\theta_1x_1+\cdots +\theta_nx_n$$，现在使用b替换$$\theta_0$$,替换后的形式变为$$w^{ T }x=w_{ 1 }x_{ 1 }+\cdots +w_{ n }x_{ n }+b$$，这样做之后，我们的假设函数就变成了</p>
<p>$$
h_{ b,w }\left( x \right) =g\left( w^{ T }x+b \right)
$$</p>
<p>和逻辑回归的形式很相像。</p>
<p>表达形式就引申到这里，在来谈下SVM的思想，当我们学习线性回归时，我们的想法就是使用最小二乘法拟合数据，而在分类问题中，我们的想法就是找到一条直线，使正负样本离这个线或者超平面尽可能的远。也就是<code>间隔</code>最大。用一句话来说就是：<strong>在特征空间上的间隔最大的线性分类器。所以我们所有的努力都在如何是间隔最大化上，而这个可以转化为一个凸二次规划的问题</strong>。所以SVM的学习算法就是求解凸二次规划的最优化算法。</p>
<p>#####函数间隔（functional margin）和几何间隔（geometric margin）</p>
<p>我们定义函数间隔就是：对于给定的数据集T和超平面（w,b），样本点$$\left( x^{(i)},y^{(i)} \right) $$到超平面的函数间隔为：
$$
\widehat { \gamma  } ^{ (i) }=y^{ (i) }(w^{T}\cdot x^{ (i) }+b)
$$</p>
<p>函数间隔或者间隔本身描述了一种确信度。离超平面越远，间隔值就越大，可信度就越大。</p>
<p>刚刚我们定义的函数间隔是针对某一个样本的，现在我们定义全局样本上的函数间隔，定义超平面关于数据集的函数间隔为超平面中所有样本点函数间隔的最小值，就是在训练样本上分类正例和负例确信度最小那个函数间隔，即</p>
<p>$$
\widehat {\gamma }=\min _{ i=1,...m }{ \widehat { \gamma  } ^{ (i) } }
$$</p>
<p>但是有个问题，如果按比例的增加w和b，那么函数间隔也会按比例改变，这个对结果没有影响，但是问题会变得不好描述，不能定量的计算，所以我们就需要把它规范化(normalization)。只需要结果除以$$\left| w \right| $$就好了，这个时候$$w/\left| w \right| $$就成为了单位向量，所以函数间隔和几何间隔的关系也就是这样简单，几何间隔就是规范化后的函数间隔。无论w和b怎么折腾，几何间隔都不会改变。</p>
<p>定义几何间隔就是：对于给定的数据集T和超平面（w,b），样本点$$\left( x^{(i)},y^{(i)} \right) $$到超平面的几何间隔为：</p>
<p>$$
{ \gamma  } ^{ (i) }=y^{ (i) }(w^{T}\cdot x^{ (i) }+b)/\left| w \right|
$$</p>
<p>定义超平面关于数据集的几何间隔为超平面中所有样本点几何间隔的最小值,即</p>
<p>$$
{ \gamma  }=\min _{ i=1,...m }{ { \gamma  }^{ (i) } }
$$</p>
<p>最优间隔分类器（optimal margin classifier）（利用间隔最大化）</p>
<p>回想前面我们提到我们的目标是寻找一个超平面，使得离超平面比较近的点能有更大的
间距。 也就是我们不考虑所有的点都必须远离超平面，我们关心求得的超平面能够让所有点中离它最近的点具有最大间距。形象的说，我们将上面的图看作是一张纸，我们要找一条折线，按照这条折线折叠后，离折线最近的点的间距比其他折线都要大。形式化表示为：</p>
<p>$$
\max _{ \gamma ,w,b }{ \gamma  } \ s.t\quad { y }^{ \left( i \right)  }\left( { w }^{ T }{ x }^{ \left( i \right)  }+b \right) \ge \gamma ,i=1,\cdots ,m\ \left| w \right| =1
$$</p>
<p>这里用||w||=1 规约 w，使得$$ w^{T}\cdot x+b$$是几何间隔。</p>
<p>到此，我们已经将模型定义出来了。如果求得了 w 和 b，那么来一个特征 x，我们就能
够分类了，称为最优间隔分类器。接下的问题就是如何求解 w 和 b 的问题了。</p>
<p>由于||w|| = 1不是凸函数，我们想先处理转化一下，考虑几何间隔和函数间隔的关系，
$$ \gamma =\frac { \hat { \gamma  }  }{ \left| w \right|  } $$，我们改写一下上面的式子：</p>
<p>$$
\max _{ \gamma ,w,b }{ \frac { \widehat { \gamma  }  }{ \left| w \right|  }  } \ s.t\quad { y }^{ \left( i \right)  }\left( { w }^{ T }{ x }^{ \left( i \right)  }+b \right) \ge \widehat { \gamma  } ,i=1,\cdots ,m
$$</p>
<p>因为函数间隔值得改变对结果没有影响，所以可以给它个固定值比如1.将 $$\hat { \gamma  } =1$$代入上面的最优化问题，因为最大化$$ \frac { 1 }{ \left| w \right|  } $$最小化$$ \frac { 1 }{ 2 } \left| w \right| ^{ 2 }$$是等价的，于是将上面改写成这样：</p>
<p>$$
\min _{ \gamma ,w,b }{ \frac { 1 }{ 2 }  } { \left| w \right|  }^{ 2 }\ s.t\quad { y }^{ \left( i \right)  }\left( { w }^{ T }{ x }^{ \left( i \right)  }+b \right) -1\ge 0,i=1,\cdots ,m
$$</p>
<p>这就变成了一个凸二次规划问题，详情见<a href="http://zh.wikipedia.org/wiki/%E4%BA%8C%E6%AC%A1%E8%A7%84%E5%88%92" target="_blank" rel="external">凸二次规划</a></p>
<p>接下来是关于拉格朗日对偶的问题，在这之后，在描述SVM中最简单的分类器——<strong>线性可分支持向量机</strong>，因为这个情况下，数据是线性可分的，而且噪音没有，只需要通过<strong>硬间隔最大化</strong>,即可学习一个线性的分类器，又称硬间隔支持向量机。</p>
<blockquote>
<blockquote>
<p>参考</p>
</blockquote>
</blockquote>
<ol>
<li>
<p>Andrew Ng的原始课件讲义</p>
</li>
<li>
<p>统计学习方法</p>
</li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/机器学习-SVM/">机器学习 SVM</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 Aluen King Lee
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>

<!--统计Aluenkinglee.github.io-->
<!--<script type="text/javascript" id="clustrmaps" src="//cdn.clustrmaps.com/map_v2.js?u=Ak87&d=RfrOeulSXrf1uWSg4T_1STgF7iU2vDrBtJLdE3MJdQY"></script>-->
<!--统计Aluenkinglee.com-->
<!--<script type="text/javascript" id="clustrmaps" src="//cdn.clustrmaps.com/map_v2.js?u=Ak87&d=fWyzUb5ADRAwJb5b2EdCj25FWOlzy8vwVQmK9vxSAYY"></script>-->
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>


<!--
-->



<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
MathJax.Hub.Register.StartupHook("TeX Jax Ready",function () {
          MathJax.InputJax.TeX.prefilterHooks.Add(function (data) {
                  data.math = data.math.replace(/^\s*<!\[CDATA\[\s*((?:\n|.)*)\s*\]\]>\s*$/m,"$1");
                    });
          });

</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });

</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });

</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });

</script>

<script type="text/javascript"
        src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>